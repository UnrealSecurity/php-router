<?php class Router{private static $host;private static $uri;private static $path;private static $query;private static $method;private static $_this;private static $routes=array();private static $accepted=false;private static $signature=null;private static $cd=null;private static $continue=false;private static $actions=['error'=>array(),];private static $firewall=null;function __construct($base_path=null){self::$_this=$this;self::$host=$_SERVER['HTTP_HOST'];self::$uri=$_SERVER['REQUEST_URI'];self::$query=$_SERVER['QUERY_STRING'];self::$path=urldecode(self::$uri);self::$method=strtoupper($_SERVER['REQUEST_METHOD']);self::$routes=array();self::$signature=md5($_SERVER['REMOTE_ADDR']);$check_extension_state=true;}function cd($path){self::$cd=$path;}function setClientSignature(...$signature){self::$signature=md5(join('\0',$signature));}function getClientSignature(){return self::$signature;}function is_accepted(){return self::$accepted;}function firewall($firewall){self::$firewall=$firewall;}function route($method,$host,$route,$action,$regexp=false,$reOptions=null){if($regexp&&self::$cd!=null){$route='/'.str_replace('/','\/',self::$cd).$route.'/'.($reOptions!=null?$reOptions:"");}else if(!$regexp&&self::$cd!=null){$route=self::trim(self::$cd.$route);}$method=strtoupper($method);if(!$regexp&&substr($route,strlen($route)-1)!=='/')$route.='/';self::$routes[]=['method'=>$method,'host'=>$host,'route'=>$route,'action'=>$action,'regexp'=>$regexp,];}function routex($method,$host,$route,$action,$reOptions=null){self::route($method,$host,$route,$action,true,$reOptions);}function error($host=null,$action){if($host==null)$host='';self::$actions['error'][$host]=$action;}function status($status){http_response_code($status);}function sendfile($filepath,$attachment=false,$newName=null,$mimetype='application/octet-stream'){if($newName==null)$newName=basename($filepath);header("Content-type: ".$mimetype);if($attachment){header("Content-disposition: attachment;filename=".$newName);}readfile($filepath);}function sendmedia($file){$fp=@fopen($file,'rb');$size=filesize($file);$length=$size;$start=0;$end=$size-1;header('Content-type: '.mime_content_type($file));header('Content-length: '.filesize($file));header('Accept-Ranges: bytes');if(isset($_SERVER['HTTP_RANGE'])){$c_start=$start;$c_end=$end;list(,$range)=explode('=',$_SERVER['HTTP_RANGE'],2);if(strpos($range,',')!==false){header('HTTP/1.1 416 Requested Range Not Satisfiable');header("Content-Range: bytes $start-$end/$size");exit;}if($range=='-'){$c_start=$size-substr($range,1);}else{$range=explode('-',$range);$c_start=$range[0];$c_end=(isset($range[1])&&is_numeric($range[1]))?$range[1]:$size;}$c_end=($c_end>$end)?$end:$c_end;if($c_start>$c_end||$c_start>$size-1||$c_end>=$size){header('HTTP/1.1 416 Requested Range Not Satisfiable');header("Content-Range: bytes $start-$end/$size");exit;}$start=$c_start;$end=$c_end;$length=$end-$start+1;fseek($fp,$start);header('HTTP/1.1 206 Partial Content');}header("Content-Range: bytes $start-$end/$size");header("Content-Length: ".$length);$buffer=1024*8;while(!feof($fp)&&($p=ftell($fp))<=$end){if($p+$buffer>$end){$buffer=$end-$p+1;}set_time_limit(0);echo fread($fp,$buffer);flush();}fclose($fp);exit();}function continue(){self::$continue=true;}function split($str){$arr=explode('/',$str);$result=array();for($i=0;$i<count($arr);$i++){if(strlen($arr[$i])>0)$result[]=$arr[$i];}return $result;}function trim($str){$str=strtok($str,'?');while(true){if(strpos($str,'//')!=true&&strpos($str,'..')!=true)break;$str=str_replace('..','.',$str);$str=str_replace('//','/',$str);}if(strlen($str)>0&&$str[strlen($str)-1]=='/'){return substr($str,0,strlen($str)-1);}return $str;}function serve($root,$self=null,$values=null,$dirless=false){$indexes=['index.php','index.html'];$includes=['php','html'];$dirless_exts=['php','html'];$media=['mp4','mp3','ogg','webm','avi','wav','mov','mpeg','mpg'];$mimetypes=['htm'=>'text/html','html'=>'text/html','js'=>'text/javascript','txt'=>'text/plain','bmp'=>'image/bmp','jpg'=>'image/jpeg','jpeg'=>'image/jpeg','png'=>'image/png','css'=>'text/css','aac'=>'audio/aac','abw'=>'application/x-abiword','arc'=>'application/x-freearc','avi'=>'video/x-msvideo','azw'=>'application/vnd.amazon.ebook','bin'=>'application/octet-stream','bz'=>'application/x-bzip','bz2'=>'application/x-bzip2','csh'=>'application/x-csh','csv'=>'text/csv','doc'=>'application/msword','docx'=>'application/vnd.openxmlformats-','eot'=>'application/vnd.ms-fontobject','epub'=>'application/epub+zip','gz'=>'application/gzip','gif'=>'image/gif','ico'=>'image/x-icon','ics'=>'text/calendar','jar'=>'application/java-archive','json'=>'application/json','jsonld'=>'application/ld+json','mid'=>'audio/midi','midi'=>'audio/midi','mjs'=>'text/javascript','mp3'=>'audio/mpeg','mp4'=>'video/mp4','mpeg'=>'video/mpeg','mpkg'=>'application/vnd.apple.installer+xml','odp'=>'application/vnd.oasis.opendocument.presentation','ods'=>'application/vnd.oasis.opendocument.spreadsheet','odt'=>'application/vnd.oasis.opendocument.text','oga'=>'audio/ogg','ogv'=>'video/ogg','ogx'=>'application/ogg','opus'=>'audio/opus','otf'=>'font/otf','pdf'=>'application/pdf','php'=>'text/html','ppt'=>'application/vnd.ms-powerpoint','pptx'=>'application/vnd.openxmlformats-officedocument.presentationml.presentation','rar'=>'application/vnd.rar','rtf'=>'application/rtf','sh'=>'application/x-sh','svg'=>'image/svg+xml','swf'=>'application/x-shockwave-flash','tar'=>'application/x-tar','tif'=>'image/tiff','tiff'=>'image/tiff','ts'=>'video/mp2t','ttf'=>'font/ttf','vsd'=>'application/vnd.visio','wav'=>'audio/wav','weba'=>'audio/webm','webm'=>'video/webm','webp'=>'image/webp','woff'=>'font/woff','woff2'=>'font/woff2','xhtml'=>'application/xhtml+xml','xls'=>'application/vnd.ms-excel','xlsx'=>'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet','xml'=>'application/xml','xul'=>'application/vnd.mozilla.xul+xml','zip'=>'application/zip','7z'=>'application/x-7z-compressed'];if($self==null||$values==null){echo '<h2>Error!</h2> Call to <b>Router::serve()</b> failed because <b>$self</b> and/or <b>$values</b> was not set';die();}$uri=$values['uri'];$path=$self::trim($uri);$flag=strlen($values['query'])>0;if(is_dir($root.$path)){if(!$flag&&$uri[strlen($uri)-1]!='/'){header('Location: '.$uri.'/');die();}else{$found=false;foreach($indexes as $index){if(file_exists($root.$path.'/'.$index)){$found=true;$parts=explode('.',$root.$path.'/'.$index);$ext=(count($parts)>1?strtolower($parts[count($parts)-1]):null);if($ext!=null&&array_key_exists($ext,$mimetypes)){header('Content-Type: '.$mimetypes[$ext]);}include_once($root.$path.'/'.$index);break;}}if(!$found){$self::status(403);}}}else{if($dirless){foreach($dirless_exts as $de){if(file_exists($root.$path.'.'.$de)){$path.='.'.$de;break;}}}if(file_exists($root.$path)){$parts=explode('.',$path);$ext=(count($parts)>1?strtolower($parts[count($parts)-1]):null);if($ext!=null&&array_key_exists($ext,$mimetypes)){header('Content-Type: '.$mimetypes[$ext]);}if($ext!=null&&in_array($ext,$includes)){include_once($root.$path);}else if($ext!=null&&in_array($ext,$media)){$self::sendmedia($root.$path);}else{$self::sendfile($root.$path,false,'',(array_key_exists($ext,$mimetypes)?$mimetypes[$ext]:mime_content_type($root.$path)));}}else{$self::status(404);}}}function request($method,$url,$headers=null,$body=null,$timeout=20){$method=strtoupper($method);$ch=curl_init($url);curl_setopt($ch,CURLOPT_CUSTOMREQUEST,$method);curl_setopt($ch,CURLOPT_FOLLOWLOCATION,1);curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);curl_setopt($ch,CURLOPT_CONNECTTIMEOUT,$timeout);if($body!=null)curl_setopt($ch,CURLOPT_POSTFIELDS,$body);if($headers!=null){$_headers=array();foreach($headers as $key=>$value){$_headers[]=$key.': '.$value;}curl_setopt($ch,CURLOPT_HTTPHEADER,$_headers);}$re=curl_exec($ch);curl_close($ch);return $re;}function lshift($arr,$n=1){array_splice($arr,0,$n);return $arr;}function accept(){self::$accepted=true;if(self::$firewall!=null){$client_ip=$_SERVER['REMOTE_ADDR'];self::$firewall::test($client_ip);}$found=false;$values=['host'=>self::$host,'uri'=>self::$uri,'path'=>self::$path,'method'=>self::$method,'query'=>self::$query];for($i=count(self::$routes)-1;$i>=0;$i--){$obj=self::$routes[$i];if($obj['host']==null||$obj['host']==self::$host){if($obj['regexp']===true){$matches=false;if(($obj['method']=='*'||self::$method==$obj['method'])&&preg_match($obj['route'],self::$path,$matches)){if($matches!=false)array_shift($matches);$found=true;$obj['action'](self::$_this,$values,...$matches);if(!self::$continue){break;}self::$continue=false;}}else{if(substr(self::$path,strlen(self::$path)-1)!=='/')self::$path.='/';if(($obj['method']=='*'||self::$method==$obj['method'])&&$obj['route']===self::$path){$found=true;$obj['action'](self::$_this,$values);if(!self::$continue){break;}self::$continue=false;}}}}if(!$found){if(array_key_exists(self::$host,self::$actions['error'])&&self::$actions['error'][self::$host]!=null){self::$actions['error'][self::$host](self::$_this,$values);}else if(array_key_exists('',self::$actions['error'])&&self::$actions['error']['']!=null){self::$actions['error'][''](self::$_this,$values);}}}}class RouterFirewall{private static $router=null;private static $rules=array();private static $history=array();private static $prefix='rwaf_';private static $record_ttl=5;private static $threshold=4;private static $_this;private static $inspector=true;private static $patterns=["/<script/","/script>/","/\[\]=/",];private static $events=['denied'=>null,'limited'=>null,'allowed'=>null,'stopped'=>null,];function __construct($router,$check_extension_state=false){self::$_this=$this;self::$router=$router;if($check_extension_state&&!extension_loaded('apcu')){echo '<h2>Error!</h2> Module <b>APCu</b> (APC User Cache) needs to be loaded in order for RouterFirewall to work';die();}}function limited($action){self::$events['limited']=$action;}function denied($action){self::$events['denied']=$action;}function allowed($action){self::$events['allowed']=$action;}function stopped($action){self::$events['stopped']=$action;}function defaults($threshold,$record_ttl,$enable_inspector=false){self::$threshold=$threshold;self::$record_ttl=$record_ttl;self::$inspector=$enable_inspector;}function inspect(){$post=urldecode(file_get_contents('php://input'));$get=urldecode($_SERVER['REQUEST_URI']);for($i=0;$i<count(self::$patterns);$i++){$pattern=self::$patterns[$i];if(preg_match($pattern,$get)!=false||preg_match($pattern,$post)!=false){return true;}}return false;}function reset(){$rules_apc_key=self::$prefix.'rules';if(apcu_exists($rules_apc_key)){apcu_store($rules_apc_key,array());}}function test($client_ip=null){if($client_ip==null)$client_ip=$_SERVER['REMOTE_ADDR'];$key=self::$prefix.self::$router::getClientSignature();if(self::$inspector&&self::inspect()){if(self::$events['stopped']!=null){self::$events['stopped'](self::$_this,$client_ip);}self::$router::status(400);die();}$bypass_ratelimit=false;$rules_apc_key=self::$prefix.'rules';if(apcu_exists($rules_apc_key)){$rules=apcu_fetch($rules_apc_key);for($i=count($rules)-1;$i>=0;$i--){$type=$rules[$i][0];$addr=$rules[$i][1];$regexp=$rules[$i][2];if((!$regexp&&$client_ip===$addr)||($regexp&&preg_match($addr,$client_ip)!=false)){if($type==='deny'){if(self::$events['denied']!=null){self::$events['denied'](self::$_this,$client_ip);}self::$router::status(403);die();}else if($type==='allow'){if(self::$events['allowed']!=null){self::$events['allowed'](self::$_this,$client_ip);}$bypass_ratelimit=true;break;}}}}for($i=count(self::$rules)-1;$i>=0;$i--){$type=self::$rules[$i][0];$addr=self::$rules[$i][1];$regexp=self::$rules[$i][2];if((!$regexp&&$client_ip===$addr)||($regexp&&preg_match($addr,$client_ip)!=false)){if($type==='deny'){if(self::$events['denied']!=null){self::$events['denied'](self::$_this,$client_ip);}self::$router::status(403);die();}else if($type==='allow'){if(self::$events['allowed']!=null){self::$events['allowed'](self::$_this,$client_ip);}$bypass_ratelimit=true;break;}}}if(!$bypass_ratelimit){if(!apcu_exists($key)){apcu_add($key,0,self::$record_ttl);}else{apcu_inc($key,1);if((int)apcu_fetch($key)>self::$threshold){if(self::$events['limited']!=null){self::$events['limited'](self::$_this,$client_ip);}self::$router::status(429);die();}}}}function rule($type,$ip_patterns,$regexp=false){$type=strtolower($type);if(gettype($ip_patterns)!='array'){$ip_patterns=array($ip_patterns);}if(self::$router::is_accepted()){$key=self::$prefix.'rules';if(!apcu_exists($key)){apcu_store($key,array());}$data=apcu_fetch($key);foreach($ip_patterns as $pattern){$data[]=[$type,$pattern,$regexp];}apcu_store($key,$data);}else{foreach($ip_patterns as $pattern){self::$rules[]=[$type,$pattern,$regexp];}}}function rulex($type,$ip_patterns){self::rule($type,$ip_patterns,true);}} ?>